
# 基于 Playwright 的全球 Google 搜索爬虫开发文档

| 文档版本 | V1.0 |
| :--- | :--- |
| **文档类型** | 技术设计概览与实施指南 (PRD) |
| **核心技术** | Playwright (Browser Automation) |
| **目标功能** | 根据地理位置自动匹配 Google 域名，执行本地化搜索并返回结构化数据 |

---

## 1. 项目概述

本项目旨在构建一个高仿真的浏览器自动化服务，用于替代传统的 API 接口。通过控制真实的浏览器实例访问 Google 搜索，能够绕过大部分基于静态请求的反爬虫机制，并利用域名切换策略，获取不同国家或地区的真实搜索结果（SERP）。

### 1.1 背景与动机
传统的爬虫直接请求 HTML 容易被拦截，且官方 API 价格昂贵且数据维度受限。通过浏览器自动化方案，我们可以获得“所见即所得”的完整页面数据，特别是对于 SEO 分析、本地化舆情监控以及为 AI Agent 提供实时联网数据具有重要价值。

### 1.2 核心目标
*   **本地化精准**：确保搜索结果符合目标地区（如香港、日本）的真实排名。
*   **高可用性**：具备自动重试、IP 切换和验证码识别能力。
*   **易集成**：提供标准化的数据输出接口，便于 MCP 或其他服务调用。

---

## 2. 核心功能逻辑：智能域名切换

为了获取最贴近当地的数据，系统不能仅依赖统一的 `google.com`。Google 针对不同国家/地区部署了独立的域名，并基于域名提供差异化的搜索结果排名。

### 2.1 逻辑流程
1.  **地理位置识别**：系统启动时，自动检测当前运行环境（服务器或客户端）的出口 IP 所属的国家/地区代码（如 CN, JP, US, HK）。
2.  **域名映射匹配**：将识别到的国家代码与系统内置的“域名字典表”进行比对，检索出对应的 Google 域名后缀。
3.  **动态路由构建**：基于匹配结果，构建完整的搜索目标 URL（如 `https://www.google.co.jp/search?q=...`）。
4.  **浏览器定向访问**：Playwright 实例导航至该特定 URL，确保请求符合 Google 的本地化路由规则。

### 2.2 优势
*   **结果精准度**：直接访问当地站点，能获取当地用户真实看到的排名。
*   **语言适配**：当地域名通常会自动匹配当地语言界面，减少编码转换带来的数据丢失。

---

## 3. 全球 Google 域名映射字典表

以下为系统内置的核心映射数据字典。系统在运行时将根据此表进行自动查找与切换。

| 地区 / 国家 | 国家/地区代码 | Google 域名 | 备注 |
| :--- | :--- | :--- | :--- |
| **全球通用** | US / Global | `www.google.com` | 默认选项，通常偏向美国结果 |
| **中国香港** | HK | `www.google.com.hk` | 针对香港特别行政区 |
| **中国台湾** | TW | `www.google.com.tw` | 针对台湾地区 |
| **日本** | JP | `www.google.co.jp` | 针对日本本土 |
| **韩国** | KR | `www.google.co.kr` | 针对韩国本土 |
| **英国** | GB | `www.google.co.uk` | 针对英国 |
| **德国** | DE | `www.google.de` | 针对德国 |
| **法国** | FR | `www.google.fr` | 针对法国 |
| **俄罗斯** | RU | `www.google.ru` | 针对俄罗斯 |
| **巴西** | BR | `www.google.com.br` | 针对巴西 |
| **加拿大** | CA | `www.google.ca` | 针对加拿大（英语/法语） |
| **澳大利亚** | AU | `www.google.com.au` | 针对澳大利亚 |
| **印度** | IN | `www.google.co.in` | 针对印度 |
| **新加坡** | SG | `www.google.com.sg` | 针对新加坡 |
| **意大利** | IT | `www.google.it` | 针对意大利 |
| **西班牙** | ES | `www.google.es` | 针对西班牙 |
| **墨西哥** | MX | `www.google.com.mx` | 针对墨西哥 |
| **荷兰** | NL | `www.google.nl` | 针对荷兰 |
| **印度尼西亚** | ID | `www.google.co.id` | 针对印度尼西亚 |
| **泰国** | TH | `www.google.co.th` | 针对泰国 |
| **越南** | VN | `www.google.com.vn` | 针对越南 |
| **阿根廷** | AR | `www.google.com.ar` | 针对阿根廷 |
| **沙特阿拉伯** | SA | `www.google.com.sa` | 针对沙特阿拉伯 |
| **阿联酋** | AE | `www.google.ae` | 针对阿联酋 |
| **土耳其** | TR | `www.google.com.tr` | 针对土耳其 |
| **波兰** | PL | `www.google.pl` | 针对波兰 |
| **南非** | ZA | `www.google.co.za` | 针对南非 |

*注：部分国家或地区可能无独立二级域名，系统应配置回退机制，默认回退至 `google.com`。*

---

## 4. 实施流程说明

本章节描述系统内部的执行步骤，不涉及具体代码语法。

### 4.1 初始化阶段
*   **加载配置**：系统启动，读取上述的“域名映射字典表”至内存缓存。
*   **环境探测**：调用网络地理位置识别接口（或读取本地 IP 信息），获取当前环境的 Location Code（如 `JP`）。
*   **浏览器实例化**：启动 Playwright 的 Chromium 引擎，配置浏览器上下文，设置符合目标地区的 User-Agent 和语言偏好。

### 4.2 执行阶段
*   **URL 拼接**：
    *   获取用户输入的关键词。
    *   获取环境探测到的 Location Code（`JP`）。
    *   在字典中查找 `JP` 对应的域名 `google.co.jp`。
    *   生成完整访问路径：`https://www.google.co.jp`。
*   **页面导航**：浏览器实例导航至该路径。
*   **反爬虫交互处理**：
    *   **Cookie 同意弹窗**：系统监测页面是否有“接受所有”或“I agree”类型的 Cookie 弹窗。若存在，自动执行点击操作以关闭弹窗，避免遮挡搜索框。
    *   **异常检测**：监测是否出现 CAPTCHA（验证码）页面。若出现，系统需标记该任务失败并触发告警。
*   **搜索动作执行**：
    *   定位页面上的搜索输入框。
    *   模拟键盘输入关键词。
    *   触发回车操作或点击搜索按钮。
*   **结果等待**：
    *   系统进入轮询状态，监测 DOM 结构中是否出现结果列表容器（如 `div#search`）。
    *   确认容器出现且数据填充完毕后，停止等待。

### 4.3 数据提取与返回
*   **源码捕获**：获取当前页面的完整 HTML 文档。
*   **数据封装**：将 HTML 文档封装为标准响应对象返回。
*   **资源销毁**：关闭浏览器实例，释放内存资源。

---

## 5. 系统架构设计

为了支持高并发请求与灵活的地区切换，系统不应采用简单的单一线程脚本模式，而应采用**分层架构**与**资源池化**的设计。

### 5.1 逻辑架构图（概念）
系统分为四个核心层级：

1.  **接入层**：
    *   负责接收外部的搜索请求（如 HTTP API 调用）。
    *   解析请求参数：关键词、目标地区代码、是否需要详细内容等。

2.  **调度控制层**：
    *   **策略决策**：根据请求的地区代码（如 `JP`），查询“域名字典表”与“代理 IP 池”，获取匹配的资源（日本域名 + 日本代理 IP）。
    *   **任务分发**：将任务放入队列，等待空闲的浏览器实例处理。

3.  **执行层**：
    *   **浏览器实例池**：维护一定数量的 Playwright 浏览器实例。实例在空闲时驻留，繁忙时复用，避免频繁启动关闭的开销。
    *   **自动化引擎**：在隔离的 Browser Context 中执行导航、输入、点击操作。

4.  **数据处理层**：
    *   **清洗模块**：去除 HTML 中的脚本、样式等噪音，提取核心的 DOM 节点。
    *   **封装模块**：将提取的数据组装成统一格式返回。

### 5.2 核心组件交互
*   **Geo-Service（定位服务）**：独立组件，用于定期检测代理 IP 的真实地理位置，确保 IP 库中的数据准确无误。
*   **Proxy-Manager（代理管理器）**：负责代理 IP 的健康检查。如果某个 IP 无法访问 Google，自动剔除并获取新 IP。

---

## 6. 数据输出标准定义

为了方便上层应用（如 MCP 服务或 AI 模型）直接消费，系统不应只返回原始 HTML，应提供**结构化数据**与**原始数据**两种形式。

### 6.1 标准响应结构
建议返回包含以下字段的 JSON 对象：

*   **meta (元数据)**：
    *   `region_code`：实际执行搜索的地区代码（如 `JP`）。
    *   `target_url`：最终访问的 Google 完整 URL。
    *   `used_proxy`：本次请求使用的代理 IP（脱敏处理，仅用于调试）。
    *   `latency`：请求总耗时（毫秒）。

*   **results (搜索结果列表)**：
    *   `rank`：排名序号（1, 2, 3...）。
    *   `title`：网页标题。
    *   `link`：目标跳转链接（需清洗 Google 的跳转参数，获取真实 URL）。
    *   `snippet`：搜索结果摘要文字。
    *   `cite_url`：显示的引用网址。

*   **raw_html (原始数据)**：
    *   `content`：Base64 编码的页面 HTML 源码（或纯文本，取决于数据量大小）。

---

## 7. 异常处理与稳定性保障策略

Google 的风控机制非常严格，系统必须具备强大的容错与恢复能力。

### 7.1 异常场景分类
1.  **网络超时**：连接代理服务器或 Google 服务器超过设定阈值（如 30 秒）。
2.  **验证码触发 (CAPTCHA)**：页面检测到 "I'm not a robot" 或图片验证码。
3.  **服务端封锁**：返回 HTTP 429 (Too Many Requests) 或 503。
4.  **元素定位失败**：Google 更改了页面结构，导致找不到搜索框或结果列表。

### 7.2 自动化处理策略
*   **自动重试机制**：
    *   遇到超时或 5xx 错误时，系统不应立即报错，而应标记该任务为“重试”。
    *   **策略**：最大重试次数为 3 次。每次重试必须**切换代理 IP** 和 **切换浏览器实例**，以避免因单一 IP 频繁请求导致永久封锁。
*   **验证码拦截**：
    *   系统检测到 DOM 中存在验证码特征（如特定的 class name）。
    *   **动作**：立即结束当前任务，标记为“Captcha_Block”，并通知运维人员该 IP 段已失效。
*   **降级策略**：
    *   如果特定国家的代理 IP 全部耗尽，系统可尝试回退到 `google.com`（全球版），并在结果中标注“结果可能包含非本地化内容”。

---

## 8. 部署与运维环境

### 8.1 运行环境要求
*   **操作系统**：推荐使用 Linux (Ubuntu 20.04+ / CentOS)。Windows 虽然支持，但在无界面模式下性能较差且资源占用高。
*   **依赖库**：必须安装 Playwright 及其系统依赖库（如各类图形库、字体库），否则无头模式无法渲染页面。
*   **网络配置**：服务器必须具备高带宽，且对代理 IP 节点的网络延迟有要求（建议选择距离代理池较近的服务器部署）。

### 8.2 容器化部署
*   **推荐方案**：使用 Docker 容器部署。
*   **镜像构建**：在 Dockerfile 中预先安装好浏览器内核和 Playwright 依赖，缩小镜像体积。
*   **资源限制**：需要为容器分配足够的内存（建议每个浏览器实例预留 512MB-1GB 内存），并限制 CPU 核心数，防止单个实例卡死导致宿主机崩溃。

---

## 9. 风险控制与合规性

### 9.1 技术风险
*   **IP 封禁**：即便使用了代理 IP，仍有可能面临 Google 针对数据中心 IP 的封锁。
    *   *对策*：引入“住宅代理” 资源，这类 IP 模拟真实家庭宽带，更难被识别。
*   **指纹泄露**：浏览器指纹特征过于明显。
    *   *对策*：定期更新 Playwright 版本，配合 `stealth` 插件隐藏自动化特征。

### 9.2 法律与合规风险
*   **数据归属**：Google 的搜索结果页面受版权保护。
    *   *对策*：本服务仅用于“技术研究”或“公开信息索引”，不得直接复制 Google 的搜索结果页面用于构建竞品搜索引擎。
*   **条款违约**：违反 Google 的服务条款。
    *   *对策*：在请求头中尽量遵守 `robots.txt` 规则（尽管爬虫通常忽略），并控制请求频率，避免对 Google 服务器造成 DDOS 攻击效果。

---

## 10. 技术注意事项与优化策略

### 10.1 IP 强关联性（关键）
虽然切换了域名（如使用 `google.co.jp`），但如果服务器的出口 IP 位于美国，Google 仍可能通过 IP 识别返回美式结果。
*   **解决方案**：域名切换策略必须配合**代理 IP 池**使用。当检测到目标地区为日本时，系统不仅应切换域名，还应从代理池中调度日本的 IP 节点进行请求。

### 10.2 浏览器指纹
Playwright 默认的 Headless 模式特征容易被识别。
*   **优化建议**：在生产环境中，应配置 `navigator.webdriver` 属性隐藏，并调整 WebGL 渲染器参数，使其看起来更像普通用户。

### 10.3 性能消耗
浏览器自动化属于重资源操作。
*   **优化建议**：由于单个 Chromium 实例占用内存较大（约 200MB-500MB），建议在服务端实现“实例池”管理，避免为每个请求都重新启动和关闭浏览器，可采用复用策略。

### 10.4 字符编码
不同国家的 Google 域名页面编码可能不同（如 Shift-JIS 或 UTF-8）。
*   **优化建议**：在数据提取阶段，统一将 HTML 内容转换为 UTF-8 编码，防止后续解析出现乱码。

---

## 11. 未来迭代规划

*   **V1.1 版本（内容增强）**：
    *   集成“深度抓取”功能。在返回搜索结果链接的同时，自动启动子任务，去抓取目标网页的正文内容，直接返回给 AI 模型。
*   **V1.2 版本（搜索类型扩展）**：
    *   支持 Google 图片搜索、Google 新闻搜索、Google 学术搜索。
*   **V2.0 版本（智能分布式）**：
    *   支持分布式节点。在不同国家部署本地节点，从物理上实现“本地化访问”，彻底解决代理 IP 延迟和不稳定的问题。

---

## 12. 附录：关键检查清单

在开发完成后，需通过以下测试用例：

*   [ ] **本地化测试**：设置地区为日本，验证搜索结果是否包含 `.co.jp` 域名且包含日文摘要。
*   [ ] **弹窗处理测试**：验证是否自动点击了 "Accept all" 或 "I agree"。
*   [ ] **IP 切换测试**：手动封禁当前代理 IP，验证系统是否自动切换 IP 并重试成功。
*   [ ] **资源释放测试**：连续执行 100 次任务，监控服务器内存，确认没有内存泄漏（僵尸进程）。
*   [ ] **异常数据清洗**：搜索结果中不应包含 Google 的“为您推荐”或“相关搜索”等干扰性数据。
```